// Test file generated by our web UI
// This code should work immediately after running the setup commands

import { createClient } from "polkadot-api"
import { start } from "polkadot-api/smoldot"
import { getSmProvider } from "polkadot-api/sm-provider"
import { chainSpec } from "polkadot-api/chains/polkadot"
import { polkadot } from "./.papi/descriptors/dist/index.mjs"

async function testGeneratedCode() {
  console.log('🚀 Starting PAPI test with generated code...');
  
  try {
    // Initialize smoldot
    console.log('📡 Initializing smoldot light client...');
    const smoldot = start();
    
    // Add chain
    console.log('🔗 Adding Polkadot chain...');
    const chain = await smoldot.addChain({ 
      chainSpec 
    });
    console.log('✅ Chain added successfully');
    
    // Create client
    console.log('🔌 Creating PAPI client...');
    const client = createClient(getSmProvider(chain));
    console.log('✅ Client created successfully');
    
    // Get typed API
    console.log('📋 Getting typed API...');
    const typedApi = client.getTypedApi(polkadot);
    console.log('✅ Typed API obtained successfully');
    
    // Test a simple query
    console.log('🔍 Testing System.Number query...');
    const blockNumber = await typedApi.query.System.number();
    console.log('✅ Block number query successful:', blockNumber);
    
    // Test getting account info
    console.log('👤 Testing System.Account query...');
    const accountInfo = await typedApi.query.System.account("5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY");
    console.log('✅ Account info query successful');
    console.log('   Nonce:', accountInfo.nonce);
    console.log('   Free balance:', accountInfo.data.free);
    
    // Test transaction creation (without submitting)
    console.log('📝 Testing transaction creation...');
    const call = typedApi.tx.Balances.transfer_allow_death({
      dest: "5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty",
      value: 1000000000000n
    });
    console.log('✅ Transaction created successfully');
    
    // Get encoded data
    console.log('🔐 Getting encoded transaction data...');
    const encodedData = await call.getEncodedData();
    console.log('✅ Transaction encoding successful, length:', encodedData.length);
    
    // Cleanup
    console.log('🧹 Cleaning up...');
    smoldot.terminate();
    console.log('✅ Smoldot terminated');
    
    console.log('🎉 ALL TESTS PASSED! Our generated code works perfectly!');
    
  } catch (error) {
    console.error('❌ Test failed:', error);
    throw error;
  }
}

// Run the test
testGeneratedCode().catch(console.error);
